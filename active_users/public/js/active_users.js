!function(){"use strict";frappe.provide("frappe._active_users"),frappe.provide("frappe.dom");class s{constructor(){if(null!=frappe.desk){this.is_online=!!frappe.is_online&&frappe.is_online(),this.on_online=null,this.on_offline=null;var s=this;$(window).on("online",function(){s.is_online=!0,s.on_online&&s.on_online.call(s),s.on_online=null}),$(window).on("offline",function(){s.is_online=!1,s.on_offline&&s.on_offline.call(s),s.on_offline=null}),this.settings={},this.data=[],this.setup()}else frappe.throw(__("Active Users plugin can not be used outside Desk."))}destroy(){this.clear_sync(),this.$loading&&this.$loading.hide(),this.$reload&&this.$reload.off("click").hide(),this.$app&&this.$app.remove(),this.data=this._on_online=this._on_offline=this._syncing=null,this.$app=this.$body=this.$loading=this.$footer=this.$reload=null}error(s,e){this.destroy(),frappe.throw(__(s,e))}request(s,e,i){var n=this;return new Promise(function(t,a){var r={method:"active_users.utils.api."+s,async:!0,freeze:!1,callback:function(s){if(s&&$.isPlainObject(s)&&(s=s.message||s),!$.isPlainObject(s))return n.error("Active Users plugin received invalid "+i+"."),void a();if(s.error)return n.error(s.message),void a();var r=e&&e.call(n,s);t(r||s)}};try{frappe.call(r)}catch(s){(console.error||console.log)("[Active Users]",s),this.error("An error has occurred while sending a request."),a()}})}setup(){if(this.is_online){var s=this;this.sync_settings().then(function(){s.settings.enabled&&Promise.resolve().then(function(){s.setup_display()}).then(function(){s.sync_reload()})})}else this.on_online=this.setup}sync_settings(){return this.request("get_settings",function(s){s.enabled=cint(s.enabled),s.refresh_interval=6e4*cint(s.refresh_interval),s.allow_manual_refresh=cint(s.allow_manual_refresh),this.settings=s},"settings")}setup_display(){var s=__("Active Users");this.$app=$('\n            <li class="nav-item dropdown dropdown-notifications dropdown-mobile active-users-navbar-item" title="'+s+'">\n                <a class="nav-link active-users-navbar-icon text-muted"\n                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-persist="true"\n                    href="#" onclick="return false;">\n                    <span class="fa fa-user fa-lg fa-fw"></span>\n                </a>\n                <div class="dropdown-menu active-users-list" role="menu">\n                    <div class="fluid-container">\n                        <div class="row">\n                            <div class="col active-users-list-header">'+s+'</div>\n                        </div>\n                    </div>\n                    <div class="row">\n                        <div class="col active-users-list-body">\n                            <div class="active-users-list-loading">\n                                <div class="active-users-list-loading-box"></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="row">\n                        <div class="col active-users-list-footer">\n                            <div class="row">\n                                <div class="col active-users-footer-text"></div>\n                                <div class="col-auto active-users-footer-icon">\n                                    <a href="#" class="active-users-footer-reload">\n                                        <span class="fa fa-refresh fa-md fa-fw"></span>\n                                    </a>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </li>\n        '),$("header.navbar > .container > .navbar-collapse > ul.navbar-nav").prepend(this.$app.get(0)),this.$body=this.$app.find(".active-users-list-body"),this.$loading=this.$body.find(".active-users-list-loading").hide(),this.$footer=this.$app.find(".active-users-footer-text"),this.$reload=this.$app.find(".active-users-footer-reload"),this.setup_manual_sync()}setup_manual_sync(){if(this.settings.allow_manual_refresh){var s=this;this.$reload.on("click",function(e){e.preventDefault(),s._syncing||s.sync_reload()}).show()}else this.$reload.off("click").hide()}sync_reload(){if(this.is_online){this.clear_sync();var s=this;Promise.resolve().then(function(){s.sync_data()}).then(function(){s.setup_sync()})}}clear_sync(){this.sync_timer&&(window.clearInterval(this.sync_timer),this.sync_timer=null)}sync_data(){this._syncing=!0,this.data.length&&(this.$footer.html(""),this.$body.empty()),this.$loading.show(),this.request("get_users",function(s){this.data=s.users&&Array.isArray(s.users)?s.users:[],this.$loading.hide(),this.update_list(),this._syncing=null},"users list")}setup_sync(){var s=this;this.sync_timer=window.setInterval(function(){s.sync_data()},this.settings.refresh_interval)}update_settings(){if(this.is_online){var s=this;this.sync_settings().then(function(){s.settings.enabled?Promise.resolve().then(function(){s.setup_manual_sync()}).then(function(){s.sync_reload()}):s.destroy()})}else this.on_online=this.update_settings}update_list(){var s=this;this.data.forEach(function(e){var i=frappe.get_avatar(null,e.full_name,e.user_image),n=e.full_name,t=$('\n                <div class="row active-users-list-item">\n                    <div class="col-auto active-users-item-avatar">'+i+'</div>\n                    <div class="col active-users-item-name">'+n+"</div>\n                </div>\n            ");s.$body.append(t.get(0))}),this.$footer.html(__("Total")+": "+this.data.length)}}frappe._active_users.init=function(){frappe._active_users._init&&frappe._active_users._init.destory(),null!=frappe.desk&&(frappe._active_users._init=new s)},$(document).ready(function(){frappe._active_users.init()})}();
//# sourceMappingURL=active_users.js.map
