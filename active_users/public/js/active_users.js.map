{"version":3,"file":"active_users.js","sources":["../../../../apps/active_users/active_users/public/js/active_users.bundle.js"],"sourcesContent":["/*\n*  Frappe Active Users Â© 2023\n*  Author:  Ameen Ahmed\n*  Company: Level Up Marketing & Software Development Services\n*  Licence: Please refer to LICENSE file\n*/\n\n\nfrappe.provide('frappe._active_users');\nfrappe.provide('frappe.dom');\n\n\nclass ActiveUsers {\n    constructor() {\n        if (frappe.desk == null) {\n            frappe.throw(__('Active Users plugin can not be used outside Desk.'));\n            return;\n        }\n        this.is_online = frappe.is_online ? frappe.is_online() : false;\n        this.on_online = null;\n        this.on_offline = null;\n        \n        var me = this;\n        $(window).on('online', function() {\n            me.is_online = true;\n            me.on_online && me.on_online.call(me);\n            me.on_online = null;\n        });\n        $(window).on('offline', function() {\n            me.is_online = false;\n            me.on_offline && me.on_offline.call(me);\n            me.on_offline = null;\n        });\n        \n        this.settings = {};\n        this.data = [];\n        \n        this.setup();\n    }\n    destroy() {\n        this.clear_sync();\n        if (this.$loading) this.$loading.hide();\n        if (this.$reload) this.$reload.off('click').hide();\n        if (this.$app) this.$app.remove();\n        this.data = this._on_online = this._on_offline = this._syncing = null;\n        this.$app = this.$body = this.$loading = this.$footer = this.$reload = null;\n    }\n    error(msg, args) {\n        this.destroy();\n        frappe.throw(__(msg, args));\n    }\n    request(method, callback, type) {\n        var me = this;\n        return new Promise(function(resolve, reject) {\n            let data = {\n                method: 'active_users.utils.api.' + method,\n                'async': true,\n                freeze: false,\n                callback: function(res) {\n                    if (res && $.isPlainObject(res)) res = res.message || res;\n                    if (!$.isPlainObject(res)) {\n                        me.error('Active Users plugin received invalid ' + type + '.');\n                        reject();\n                        return;\n                    }\n                    if (res.error) {\n                        me.error(res.message);\n                        reject();\n                        return;\n                    }\n                    let val = callback && callback.call(me, res);\n                    resolve(val || res);\n                }\n            };\n            try {\n                frappe.call(data);\n            } catch(e) {\n                (console.error || console.log)('[Active Users]', e);\n                this.error('An error has occurred while sending a request.');\n                reject();\n            }\n        });\n    }\n    setup() {\n        if (!this.is_online) {\n            this.on_online = this.setup;\n            return;\n        }\n        var me = this;\n        this.sync_settings()\n        .then(function() {\n            if (!me.settings.enabled) return;\n            Promise.resolve()\n                .then(function() { me.setup_display(); })\n                .then(function() { me.sync_reload(); });\n        });\n    }\n    sync_settings() {\n        return this.request(\n            'get_settings',\n            function(res) {\n                res.enabled = cint(res.enabled);\n                res.refresh_interval = cint(res.refresh_interval) * 60000;\n                res.allow_manual_refresh = cint(res.allow_manual_refresh);\n                this.settings = res;\n            },\n            'settings'\n        );\n    }\n    setup_display() {\n        let title = __('Active Users');\n        this.$app = $(`\n            <li class=\"nav-item dropdown dropdown-notifications dropdown-mobile active-users-navbar-item\" title=\"${title}\">\n                <a class=\"nav-link active-users-navbar-icon text-muted\"\n                    data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"true\" data-persist=\"true\"\n                    href=\"#\" onclick=\"return false;\">\n                    <span class=\"fa fa-user fa-lg fa-fw\"></span>\n                </a>\n                <div class=\"dropdown-menu active-users-list\" role=\"menu\">\n                    <div class=\"fluid-container\">\n                        <div class=\"row\">\n                            <div class=\"col active-users-list-header\">${title}</div>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col active-users-list-body\">\n                            <div class=\"active-users-list-loading\">\n                                <div class=\"active-users-list-loading-box\"></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col active-users-list-footer\">\n                            <div class=\"row\">\n                                <div class=\"col active-users-footer-text\"></div>\n                                <div class=\"col-auto active-users-footer-icon\">\n                                    <a href=\"#\" class=\"active-users-footer-reload\">\n                                        <span class=\"fa fa-refresh fa-md fa-fw\"></span>\n                                    </a>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </li>\n        `);\n        $('header.navbar > .container > .navbar-collapse > ul.navbar-nav').prepend(this.$app.get(0));\n        \n        this.$body = this.$app.find('.active-users-list-body');\n        this.$loading = this.$body.find('.active-users-list-loading').hide();\n        this.$footer = this.$app.find('.active-users-footer-text');\n        this.$reload = this.$app.find('.active-users-footer-reload');\n        \n        this.setup_manual_sync();\n    }\n    setup_manual_sync() {\n        if (!this.settings.allow_manual_refresh) {\n            this.$reload.off('click').hide();\n            return;\n        }\n        var me = this;\n        this.$reload.on('click', function(e) {\n            e.preventDefault();\n            if (!me._syncing) me.sync_reload();\n        }).show();\n    }\n    sync_reload() {\n        if (!this.is_online) return;\n        this.clear_sync();\n        var me = this;\n        Promise.resolve()\n            .then(function() { me.sync_data(); })\n            .then(function() { me.setup_sync(); });\n    }\n    clear_sync() {\n        if (this.sync_timer) {\n            window.clearInterval(this.sync_timer);\n            this.sync_timer = null;\n        }\n    }\n    sync_data() {\n        this._syncing = true;\n        if (this.data.length) {\n            this.$footer.html('');\n            this.$body.empty();\n        }\n        this.$loading.show();\n        this.request(\n            'get_users',\n            function(res) {\n                this.data = res.users && Array.isArray(res.users) ? res.users : [];\n                this.$loading.hide();\n                this.update_list();\n                this._syncing = null;\n            },\n            'users list'\n        );\n    }\n    setup_sync() {\n        var me = this;\n        this.sync_timer = window.setInterval(function() {\n            me.sync_data();\n        }, this.settings.refresh_interval);\n    }\n    update_settings() {\n        if (!this.is_online) {\n            this.on_online = this.update_settings;\n            return;\n        }\n        var me = this;\n        this.sync_settings()\n        .then(function() {\n            if (!me.settings.enabled) {\n                me.destroy();\n                return;\n            }\n            Promise.resolve()\n                .then(function() { me.setup_manual_sync(); })\n                .then(function() { me.sync_reload(); });\n        });\n    }\n    update_list() {\n        var me = this;\n        this.data.forEach(function(v) {\n            let avatar = frappe.get_avatar(null, v.full_name, v.user_image),\n            name = v.full_name,\n            item = $(`\n                <div class=\"row active-users-list-item\">\n                    <div class=\"col-auto active-users-item-avatar\">${avatar}</div>\n                    <div class=\"col active-users-item-name\">${name}</div>\n                </div>\n            `);\n            me.$body.append(item.get(0));\n        });\n        this.$footer.html(__('Total') + ': ' + this.data.length);\n    }\n}\n\nfrappe._active_users.init = function() {\n    if (frappe._active_users._init) frappe._active_users._init.destory();\n    if (frappe.desk == null) return;\n    frappe._active_users._init = new ActiveUsers();\n};\n\n$(document).ready(function() {\n    frappe._active_users.init();\n});"],"names":["frappe","provide","ActiveUsers","[object Object]","desk","this","is_online","on_online","on_offline","me","$","window","on","call","settings","data","setup","throw","__","clear_sync","$loading","hide","$reload","off","$app","remove","_on_online","_on_offline","_syncing","$body","$footer","msg","args","destroy","method","callback","type","Promise","resolve","reject","let","async","freeze","res","isPlainObject","message","error","val","e","console","log","sync_settings","then","enabled","setup_display","sync_reload","request","cint","refresh_interval","allow_manual_refresh","title","prepend","get","find","setup_manual_sync","preventDefault","show","sync_data","setup_sync","sync_timer","clearInterval","length","html","empty","users","Array","isArray","update_list","setInterval","update_settings","forEach","v","avatar","get_avatar","full_name","user_image","name","item","append","_active_users","init","_init","destory","document","ready"],"mappings":"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"}